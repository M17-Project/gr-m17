<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>GNU Radio M17 Module: Enhanced Nitrokey Integration for M17</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">GNU Radio M17 Module<span id="projectnumber">&#160;1.0.0</span>
   </div>
   <div id="projectbrief">M17 digital radio protocol with AX.25 TNC KISS support</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Enhanced Nitrokey Integration for M17</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Overview</h1>
<p>This document describes the enhanced integration of Nitrokey hardware security modules with the M17 digital radio protocol. The integration provides secure key generation, signing, and public key management using the Nitrokey 3 device and the pynitrokey library.</p>
<h1>Key Features</h1>
<h2>Hardware Security</h2>
<ul>
<li><b>Private Key Protection</b>: Private keys never leave the Nitrokey device</li>
<li><b>Secure Key Generation</b>: Ed25519 keys generated directly on hardware</li>
<li><b>Hardware Signing</b>: All cryptographic operations performed on device</li>
<li><b>Tamper Resistance</b>: Hardware-based security against key extraction</li>
</ul>
<h2>Nitrokey 3 Integration</h2>
<ul>
<li><b>pynitrokey Library</b>: Uses the official Python library for device communication</li>
<li><b>Secrets App</b>: Leverages the Nitrokey 3 secrets application for key management</li>
<li><b>Multiple Keys</b>: Support for multiple keys on a single device</li>
<li><b>Key Management</b>: Full CRUD operations for hardware keys</li>
</ul>
<h1>Implementation Details</h1>
<h2>Core Functions</h2>
<h3>Device Management</h3>
<div class="fragment"><div class="line"><span class="comment">// Check Nitrokey status and connectivity</span></div>
<div class="line"><span class="keywordtype">bool</span> check_nitrokey_status();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// List all keys stored on the Nitrokey</span></div>
<div class="line"><span class="keywordtype">bool</span> list_nitrokey_keys();</div>
</div><!-- fragment --><h3>Key Generation</h3>
<div class="fragment"><div class="line"><span class="comment">// Generate Ed25519 key on Nitrokey (private key never leaves device)</span></div>
<div class="line"><span class="keywordtype">bool</span> generate_key_on_nitrokey(<span class="keyword">const</span> std::string&amp; label);</div>
</div><!-- fragment --><h3>Key Operations</h3>
<div class="fragment"><div class="line"><span class="comment">// Export public key from Nitrokey (for sharing with others)</span></div>
<div class="line"><span class="keywordtype">bool</span> export_public_key_from_nitrokey(<span class="keyword">const</span> std::string&amp; file);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Sign data with private key stored on Nitrokey</span></div>
<div class="line"><span class="keywordtype">bool</span> sign_with_nitrokey(<span class="keyword">const</span> uint8_t* data, <span class="keywordtype">size_t</span> data_len, uint8_t* signature);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Set active key for operations</span></div>
<div class="line"><span class="keywordtype">bool</span> set_nitrokey_key(<span class="keyword">const</span> std::string&amp; label);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Delete key from Nitrokey</span></div>
<div class="line"><span class="keywordtype">bool</span> delete_nitrokey_key(<span class="keyword">const</span> std::string&amp; label);</div>
</div><!-- fragment --><h2>Command Line Interface</h2>
<p>The implementation uses the <code>nitropy</code> command-line tool for Nitrokey operations:</p>
<h3>Key Generation</h3>
<div class="fragment"><div class="line"># Generate Ed25519 key on Nitrokey (private key never leaves device)</div>
<div class="line">nitropy nk3 secrets add-password --name &quot;M17-Key-1&quot; --algorithm ed25519</div>
</div><!-- fragment --><h3>Public Key Export</h3>
<div class="fragment"><div class="line"># Export public key from Nitrokey (so others can verify/encrypt to you)</div>
<div class="line">nitropy nk3 secrets get-public-key --name &quot;M17-Key-1&quot; --output public_key.pem</div>
</div><!-- fragment --><h3>Signing</h3>
<div class="fragment"><div class="line"># Sign data with private key stored on Nitrokey</div>
<div class="line">nitropy nk3 secrets sign --name &quot;M17-Key-1&quot; --input data.bin --output signature.bin</div>
</div><!-- fragment --><h3>Key Management</h3>
<div class="fragment"><div class="line"># List all keys on Nitrokey</div>
<div class="line">nitropy nk3 secrets list</div>
<div class="line"> </div>
<div class="line"># Delete key from Nitrokey</div>
<div class="line">nitropy nk3 secrets delete --name &quot;M17-Key-1&quot;</div>
<div class="line"> </div>
<div class="line"># Check device status</div>
<div class="line">nitropy nk3 info</div>
</div><!-- fragment --><h1>Usage Examples</h1>
<h2>Basic Key Generation and Signing</h2>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;m17_coder_impl.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main() {</div>
<div class="line"> <span class="comment">// Create M17 coder</span></div>
<div class="line"> <a class="code hl_class" href="classgr_1_1m17_1_1m17__coder__impl.html">gr::m17::m17_coder_impl</a> encoder(<span class="stringliteral">&quot;N0CALL&quot;</span>, <span class="stringliteral">&quot;W1ABC&quot;</span>, 1, 0, 0, 0, 0, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Check Nitrokey status</span></div>
<div class="line"> <span class="keywordflow">if</span> (!encoder.check_nitrokey_status()) {</div>
<div class="line"> std::cerr &lt;&lt; <span class="stringliteral">&quot;Nitrokey not available\n&quot;</span>;</div>
<div class="line"> <span class="keywordflow">return</span> 1;</div>
<div class="line"> }</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Generate Ed25519 key on Nitrokey</span></div>
<div class="line"> <span class="keywordflow">if</span> (!encoder.generate_key_on_nitrokey(<span class="stringliteral">&quot;M17-Key-1&quot;</span>)) {</div>
<div class="line"> std::cerr &lt;&lt; <span class="stringliteral">&quot;Failed to generate key\n&quot;</span>;</div>
<div class="line"> <span class="keywordflow">return</span> 1;</div>
<div class="line"> }</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Export public key</span></div>
<div class="line"> <span class="keywordflow">if</span> (!encoder.export_public_key_from_nitrokey(<span class="stringliteral">&quot;public_key.pem&quot;</span>)) {</div>
<div class="line"> std::cerr &lt;&lt; <span class="stringliteral">&quot;Failed to export public key\n&quot;</span>;</div>
<div class="line"> <span class="keywordflow">return</span> 1;</div>
<div class="line"> }</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Sign message</span></div>
<div class="line"> std::string message = <span class="stringliteral">&quot;Hello, M17!&quot;</span>;</div>
<div class="line"> uint8_t signature[64];</div>
<div class="line"> <span class="keywordflow">if</span> (!encoder.sign_with_nitrokey(</div>
<div class="line"> <span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span>uint8_t*<span class="keyword">&gt;</span>(message.c_str()),</div>
<div class="line"> message.length(),</div>
<div class="line"> signature</div>
<div class="line"> )) {</div>
<div class="line"> std::cerr &lt;&lt; <span class="stringliteral">&quot;Failed to sign message\n&quot;</span>;</div>
<div class="line"> <span class="keywordflow">return</span> 1;</div>
<div class="line"> }</div>
<div class="line"> </div>
<div class="line"> std::cout &lt;&lt; <span class="stringliteral">&quot;Message signed successfully\n&quot;</span>;</div>
<div class="line"> <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aclassgr_1_1m17_1_1m17__coder__impl_html"><div class="ttname"><a href="classgr_1_1m17_1_1m17__coder__impl.html">gr::m17::m17_coder_impl</a></div><div class="ttdef"><b>Definition</b> <a href="m17__coder__impl_8h_source.html#l00199">m17_coder_impl.h:200</a></div></div>
</div><!-- fragment --><h2>Advanced Key Management</h2>
<div class="fragment"><div class="line"><span class="comment">// List all keys on Nitrokey</span></div>
<div class="line">encoder.list_nitrokey_keys();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Set active key</span></div>
<div class="line">encoder.set_nitrokey_key(<span class="stringliteral">&quot;M17-Key-2&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Import public key into M17 system</span></div>
<div class="line">encoder.import_public_key_from_file(<span class="stringliteral">&quot;W1ABC&quot;</span>, <span class="stringliteral">&quot;w1abc_public.pem&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Verify signature</span></div>
<div class="line"><span class="keywordflow">if</span> (encoder.verify_signature_from(<span class="stringliteral">&quot;W1ABC&quot;</span>, data, data_len, signature)) {</div>
<div class="line"> std::cout &lt;&lt; <span class="stringliteral">&quot;Signature verified\n&quot;</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Delete key from Nitrokey</span></div>
<div class="line">encoder.delete_nitrokey_key(<span class="stringliteral">&quot;M17-Key-Old&quot;</span>);</div>
</div><!-- fragment --><h1>Security Considerations</h1>
<h2>Hardware Security</h2>
<ul>
<li><b>Private Key Isolation</b>: Private keys never leave the Nitrokey device</li>
<li><b>Tamper Resistance</b>: Hardware-based protection against key extraction</li>
<li><b>Secure Element</b>: Uses Nitrokey's secure element for cryptographic operations</li>
<li><b>PIN Protection</b>: Device protected by user PIN</li>
</ul>
<h2>Key Management</h2>
<ul>
<li><b>Unique Labels</b>: Use descriptive labels for key identification</li>
<li><b>Key Rotation</b>: Implement regular key rotation for long-term security</li>
<li><b>Backup Strategy</b>: Export public keys for backup and sharing</li>
<li><b>Access Control</b>: Limit access to Nitrokey device</li>
</ul>
<h2>Operational Security</h2>
<ul>
<li><b>Device Verification</b>: Always verify Nitrokey status before operations</li>
<li><b>Error Handling</b>: Proper error handling for device communication failures</li>
<li><b>Temporary Files</b>: Secure cleanup of temporary files used in operations</li>
<li><b>Logging</b>: Avoid logging sensitive cryptographic material</li>
</ul>
<h1>Protocol Integration</h1>
<h2>M17 Frame Structure with Nitrokey</h2>
<div class="fragment"><div class="line">M17 Frame with Nitrokey Signing:</div>
<div class="line"> </div>
<div class="line"> Sync Word LSF (Link Payload Signature </div>
<div class="line"> (8 symbols) Setup Frame) (encrypted) (64 bytes) </div>
</div><!-- fragment --><h2>Signature Process</h2>
<ol type="1">
<li><b>Data Preparation</b>: Prepare M17 frame data for signing</li>
<li><b>Hardware Signing</b>: Use Nitrokey to sign with private key</li>
<li><b>Frame Assembly</b>: Include signature in M17 frame</li>
<li><b>Verification</b>: Recipients verify using imported public key</li>
</ol>
<h2>Public Key Distribution</h2>
<ol type="1">
<li><b>Export Public Key</b>: Export from Nitrokey to PEM file</li>
<li><b>Share Public Key</b>: Distribute PEM file to other stations</li>
<li><b>Import Public Key</b>: Import into M17 key management system</li>
<li><b>Verification</b>: Use imported public key for signature verification</li>
</ol>
<h1>Installation and Setup</h1>
<h2>Prerequisites</h2>
<div class="fragment"><div class="line"># Install pynitrokey</div>
<div class="line">pip install pynitrokey</div>
<div class="line"> </div>
<div class="line"># Install nitropy CLI</div>
<div class="line">pip install pynitrokey[cli]</div>
<div class="line"> </div>
<div class="line"># Verify installation</div>
<div class="line">nitropy --version</div>
</div><!-- fragment --><h2>Device Setup</h2>
<div class="fragment"><div class="line"># Check Nitrokey connection</div>
<div class="line">nitropy nk3 info</div>
<div class="line"> </div>
<div class="line"># Initialize device (if needed)</div>
<div class="line">nitropy nk3 init</div>
<div class="line"> </div>
<div class="line"># Set user PIN</div>
<div class="line">nitropy nk3 set-pin</div>
</div><!-- fragment --><h2>M17 Integration</h2>
<div class="fragment"><div class="line"># Build M17 with Nitrokey support</div>
<div class="line">cd gr-m17</div>
<div class="line">mkdir build &amp;&amp; cd build</div>
<div class="line">cmake ..</div>
<div class="line">make</div>
<div class="line"> </div>
<div class="line"># Run enhanced example</div>
<div class="line">./examples/nitrokey_enhanced_example</div>
</div><!-- fragment --><h1>Troubleshooting</h1>
<h2>Common Issues</h2>
<h3>Device Not Detected</h3>
<div class="fragment"><div class="line"># Check USB connection</div>
<div class="line">lsusb | grep Nitrokey</div>
<div class="line"> </div>
<div class="line"># Check device permissions</div>
<div class="line">sudo usermod -a -G plugdev $USER</div>
<div class="line"> </div>
<div class="line"># Restart udev rules</div>
<div class="line">sudo udevadm control --reload-rules</div>
</div><!-- fragment --><h3>nitropy Command Not Found</h3>
<div class="fragment"><div class="line"># Install pynitrokey with CLI support</div>
<div class="line">pip install pynitrokey[cli]</div>
<div class="line"> </div>
<div class="line"># Verify installation</div>
<div class="line">which nitropy</div>
</div><!-- fragment --><h3>Permission Denied</h3>
<div class="fragment"><div class="line"># Add user to plugdev group</div>
<div class="line">sudo usermod -a -G plugdev $USER</div>
<div class="line"> </div>
<div class="line"># Logout and login again</div>
<div class="line"># Or use newgrp plugdev</div>
</div><!-- fragment --><h2>Debug Information</h2>
<div class="fragment"><div class="line"><span class="comment">// Enable debug output</span></div>
<div class="line">encoder.set_debug(<span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Check device status</span></div>
<div class="line"><span class="keywordflow">if</span> (!encoder.check_nitrokey_status()) {</div>
<div class="line"> std::cerr &lt;&lt; <span class="stringliteral">&quot;Nitrokey not available\n&quot;</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// List available keys</span></div>
<div class="line">encoder.list_nitrokey_keys();</div>
</div><!-- fragment --><h1>Performance Characteristics</h1>
<h2>Signing Performance</h2>
<ul>
<li><b>Hardware Acceleration</b>: ~100-500 signatures/second</li>
<li><b>Latency</b>: ~2-10ms per signature operation</li>
<li><b>Power Consumption</b>: Minimal impact on battery life</li>
<li><b>USB Communication</b>: Efficient USB HID communication</li>
</ul>
<h2>Key Management</h2>
<ul>
<li><b>Key Storage</b>: Up to 100+ keys per device</li>
<li><b>Key Size</b>: 32-byte Ed25519 private keys</li>
<li><b>Public Key Export</b>: ~1-2ms per export operation</li>
<li><b>Key Listing</b>: ~10-50ms for full key list</li>
</ul>
<h1>Advanced Features</h1>
<h2>Multiple Key Support</h2>
<div class="fragment"><div class="line"><span class="comment">// Generate multiple keys</span></div>
<div class="line">encoder.generate_key_on_nitrokey(<span class="stringliteral">&quot;M17-Primary&quot;</span>);</div>
<div class="line">encoder.generate_key_on_nitrokey(<span class="stringliteral">&quot;M17-Backup&quot;</span>);</div>
<div class="line">encoder.generate_key_on_nitrokey(<span class="stringliteral">&quot;M17-Testing&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Switch between keys</span></div>
<div class="line">encoder.set_nitrokey_key(<span class="stringliteral">&quot;M17-Primary&quot;</span>);</div>
<div class="line"><span class="comment">// ... perform operations ...</span></div>
<div class="line">encoder.set_nitrokey_key(<span class="stringliteral">&quot;M17-Backup&quot;</span>);</div>
</div><!-- fragment --><h2>Key Rotation</h2>
<div class="fragment"><div class="line"><span class="comment">// Generate new key</span></div>
<div class="line">encoder.generate_key_on_nitrokey(<span class="stringliteral">&quot;M17-New&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Export public key</span></div>
<div class="line">encoder.export_public_key_from_nitrokey(<span class="stringliteral">&quot;new_public.pem&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Share with other stations</span></div>
<div class="line"><span class="comment">// ... distribute public key ...</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Delete old key</span></div>
<div class="line">encoder.delete_nitrokey_key(<span class="stringliteral">&quot;M17-Old&quot;</span>);</div>
</div><!-- fragment --><h2>Backup and Recovery</h2>
<div class="fragment"><div class="line"><span class="comment">// Export all public keys</span></div>
<div class="line">encoder.list_nitrokey_keys();</div>
<div class="line"><span class="comment">// Manually export each key for backup</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Import public keys on new device</span></div>
<div class="line">encoder.import_public_key_from_file(<span class="stringliteral">&quot;N0CALL&quot;</span>, <span class="stringliteral">&quot;backup_public.pem&quot;</span>);</div>
</div><!-- fragment --><h1>Security Best Practices</h1>
<h2>Key Management</h2>
<ul>
<li><b>Regular Rotation</b>: Rotate keys every 6-12 months</li>
<li><b>Secure Storage</b>: Store public keys securely</li>
<li><b>Access Control</b>: Limit physical access to Nitrokey</li>
<li><b>Backup Strategy</b>: Maintain secure backups of public keys</li>
</ul>
<h2>Operational Security</h2>
<ul>
<li><b>Device Verification</b>: Always verify device status</li>
<li><b>Error Handling</b>: Handle device communication failures gracefully</li>
<li><b>Logging</b>: Avoid logging sensitive operations</li>
<li><b>Cleanup</b>: Securely clean up temporary files</li>
</ul>
<h2>Network Security</h2>
<ul>
<li><b>Public Key Distribution</b>: Use secure channels for public key sharing</li>
<li><b>Verification</b>: Always verify public key authenticity</li>
<li><b>Revocation</b>: Implement key revocation procedures</li>
<li><b>Monitoring</b>: Monitor for unauthorized key usage</li>
</ul>
<h1>Future Enhancements</h1>
<h2>Planned Features</h2>
<ul>
<li><b>X25519 Support</b>: Add X25519 key exchange support</li>
<li><b>Certificate Management</b>: X.509 certificate integration</li>
<li><b>Multi-Device</b>: Support for multiple Nitrokey devices</li>
<li><b>Cloud Integration</b>: Secure cloud key backup</li>
</ul>
<h2>Research Areas</h2>
<ul>
<li><b>Post-Quantum</b>: Integration with post-quantum cryptography</li>
<li><b>Zero-Knowledge</b>: Zero-knowledge proof integration</li>
<li><b>Homomorphic</b>: Homomorphic encryption for secure processing</li>
</ul>
<h1>References</h1>
<ul>
<li><a href="https://docs.nitrokey.com/nitrokey3/">Nitrokey 3 Documentation</a></li>
<li><a href="https://github.com/Nitrokey/pynitrokey">pynitrokey Library</a></li>
<li><a href="https://pynitrokey.readthedocs.io/">nitropy CLI Documentation</a></li>
<li><a href="https://spec.m17project.org/">M17 Protocol Specification</a></li>
<li><a href="https://ed25519.cr.yp.to/">Ed25519 Digital Signatures</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
