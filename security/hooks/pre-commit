#!/bin/bash
# M17 Pre-commit Security Hook
# Prevents commits with security issues

echo "M17 Pre-commit Security Check"
echo "=============================="

# Check for sensitive data in commits (excluding LaTeX documentation)
echo "Checking for sensitive data..."
if git diff --cached | grep -v -E "\.(tex|latex|sty|cls)$" | grep -E "(secret|token)" -i | grep -v -E "(nitropy|secrets|add-password|get-public-key|delete|list|detokenize|tokenize)" -i; then
    echo "ERROR: Potential sensitive data in commit"
    echo "   Remove or mask sensitive information before committing"
    exit 1
fi

# Check for key logging (excluding LaTeX documentation and security hooks)
echo "Checking for key logging..."
if git diff --cached | grep -v -E "\.(tex|latex|sty|cls)$" | grep -v "security/hooks/" | grep -E "printf.*key|fprintf.*key|cout.*key" -i; then
    echo "ERROR: Potential key logging detected"
    echo "   Remove key logging statements before committing"
    exit 1
fi

# Check for weak randomness (excluding LaTeX documentation)
echo "Checking for weak randomness..."
if git diff --cached | grep -v -E "\.(tex|latex|sty|cls)$" | grep -E "rand\(\)|srand\(|time\(NULL\)" -i; then
    echo "ERROR: Weak randomness detected"
    echo "   Use cryptographically secure RNG (RAND_bytes, /dev/urandom)"
    exit 1
fi

# Check for insecure memory operations (excluding LaTeX documentation)
echo "Checking for insecure memory operations..."
if git diff --cached | grep -v -E "\.(tex|latex|sty|cls)$" | grep -E "memset.*0" -i; then
    echo "WARNING: memset(ptr, 0, size) detected"
    echo "   Consider using explicit_bzero for sensitive data"
    # Don't fail, just warn
fi

# Check for magic numbers (excluding LaTeX documentation)
echo "Checking for magic numbers..."
if git diff --cached | grep -v -E "\.(tex|latex|sty|cls)$" | grep -E "0x8000|0x7FFC|0x7FFF" -i; then
    echo "WARNING: Magic numbers detected"
    echo "   Consider using named constants"
    # Don't fail, just warn
fi

# Check for missing error handling (excluding LaTeX documentation)
echo "Checking for missing error handling..."
if git diff --cached | grep -v -E "\.(tex|latex|sty|cls)$" | grep -E "EVP_.*\(.*\);$" -i; then
    echo "WARNING: OpenSSL function without error checking"
    echo "   Check return values for all OpenSSL functions"
    # Don't fail, just warn
fi

# Run quick static analysis on changed files
echo "Running quick static analysis..."
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|cpp|cc|h|hpp)$')

if [ ! -z "$CHANGED_FILES" ]; then
    echo "Analyzing changed files: $CHANGED_FILES"
    
    # Run cppcheck on changed files
    if command -v cppcheck &> /dev/null; then
        cppcheck --quiet --enable=warning,style,performance \
                 --suppress=missingIncludeSystem \
                 $CHANGED_FILES 2>/dev/null || {
            echo "WARNING: Static analysis found issues"
            echo "   Review cppcheck output above"
        }
    fi
fi

echo "Pre-commit security check passed!"
echo "Safe to commit"
exit 0
